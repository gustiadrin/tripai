<div class="max-w-3xl mx-auto p-4 flex flex-col h-dvh overflow-hidden pt-[max(1rem,env(safe-area-inset-top))]"
  (touchstart)="onTouchStart($event)" (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd()">
  <div class="flex justify-between items-center mb-2">
    <h1 class="text-3xl font-bold">GymAI ğŸ‹ï¸â€â™€ï¸</h1>
    <label class="flex cursor-pointer gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="5" />
        <path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4">
        </path>
      </svg>
      <input type="checkbox" class="toggle" [checked]="theme() === 'dark'" (change)="toggleTheme()" />
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
      </svg>
    </label>
  </div>
  <div class="flex justify-between items-center mb-4">
    <a routerLink="/" class="btn btn-sm btn-outline"> â† Volver al perfil </a>
    <div class="flex gap-2">
      <button type="button" class="btn btn-sm" (click)="generateRoutine()">
        Rutina PDF
      </button>
      <button type="button" class="btn btn-sm" (click)="generateDiet()">
        Dieta PDF
      </button>
    </div>
  </div>
  <div #messagesContainer class="flex-1 min-h-0 overflow-x-hidden relative overflow-y-auto mb-4 px-2">
    @for (m of visibleMessages(); track trackByMessageId($index, m); let i =
    $index) {
    <div class="message animate-in flex mb-3" [class.justify-end]="m.sender === 'user'"
      [class.justify-start]="m.sender === 'bot'">
      <div class="px-4 py-3 rounded-2xl max-w-[80%] shadow-sm" [class.bg-blue-600]="m.sender === 'user'"
        [class.text-white]="m.sender === 'user'" [class.rounded-br-md]="m.sender === 'user'"
        [class.bg-gray-100]="m.sender === 'bot'" [class.text-gray-900]="m.sender === 'bot'"
        [class.border]="m.sender === 'bot'" [class.border-gray-200]="m.sender === 'bot'"
        [class.rounded-bl-md]="m.sender === 'bot'">
        @if (m.sender === 'bot') { @if (isTyping() && i ===
        chat.messages().length - 1) { {{ m.content }} } @else {
        <markdown class="markdown-body" [data]="m.content"></markdown>
        } } @else { {{ m.content }} }
        <div class="mt-1 text-[11px] opacity-75" [class.text-blue-100]="m.sender === 'user'"
          [class.text-gray-500]="m.sender === 'bot'">
          {{ m.sender === 'user' ? 'Enviado' : 'Recibido' }} Â· {{ m.timestamp |
          date:'shortTime' }}
        </div>
      </div>
    </div>
    } @if (isTyping()) {
    <div class="message text-left">
      <div
        class="inline-block px-4 py-2 mb-4 rounded-2xl max-w-[80%] bg-gray-100 text-gray-500 text-sm italic opacity-80">
        GymAI estÃ¡ escribiendo...
      </div>
    </div>
    }
  </div>
  @if (pdfGenerating()) {
  <div class="mt-3 alert alert-info shadow-sm flex items-center gap-2 text-sm">
    <span class="loading loading-spinner loading-sm"></span>
    <span>
      {{ pdfGenerating() === 'diet' ? 'Generando PDF de dieta, por favor
      espera...' : 'Generando PDF de rutina, por favor espera...' }}
    </span>
  </div>
  }

  <form [formGroup]="form" (ngSubmit)="send()" class="mt-3 flex gap-2 pb-safe shrink-0"
    style="padding-bottom: max(0.5rem, env(safe-area-inset-bottom))">
    <input type="text" formControlName="message" placeholder="Escribe tu mensaje..."
      class="flex-1 border border-gray-300 rounded-xl px-4 py-2 focus:outline-none text-base" enterkeyhint="send" />
    <button type="submit" class="btn btn-primary" (mousedown)="$event.preventDefault()">Enviar</button>
  </form>
</div>